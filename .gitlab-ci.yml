workflow:
  name: build_deploy
  rules:
  - if: '$CI_COMMIT_MESSAGE =~ /no-ci/'
    when: never
  - if: $CI_COMMIT_REF_NAME == "main"
    when: always
  - if: $CI_COMMIT_REF_NAME == "master"
    when: always
  - when: never

stages:          # List of stages for jobs, and their order of execution
  - build
  - deploy

build-job:       # This job runs in the build stage, which runs first.
  tags:
    - nikita-runner-shell
  stage: build
  script:
    - cd /var/www/finance-hub
    - cat $BACKEND_ENV > ./backend/.env
    - cat $WEB_ENV > ./web/.env
    - docker compose build

deploy-job:      # This job runs in the deploy stage.
  tags:
    - nikita-runner-shell
  stage: deploy  # It only runs when *both* jobs in the test stage complete successfully.
  environment: production
  script:
    - cd /var/www/finance-hub
    - cat $BACKEND_ENV > ./backend/.env
    - cat $WEB_ENV > ./web/.env
    - docker compose up -d
