name: Deploy to VPS

on:
  # Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ð¾ÑÐ»Ðµ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð³Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¸Ñ ÑÐ±Ð¾Ñ€ÐºÐ¸ Docker-Ð¾Ð±Ñ€Ð°Ð·Ð¾Ð²
  workflow_run:
    workflows: ["Docker Build and Push"]
    types:
      - completed
    branches:
      - main
      - master

  # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
  workflow_dispatch:
    inputs:
      docker_tag:
        description: "Ð¢ÐµÐ³ Docker-Ð¾Ð±Ñ€Ð°Ð·Ð° Ð´Ð»Ñ Ð´ÐµÐ¿Ð»Ð¾Ñ (Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ latest)"
        required: false
        default: "latest"

jobs:
  deploy:
    name: Deploy to VPS
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Docker image tag
        run: |
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "TAG=${{ github.event.inputs.docker_tag }}" >> $GITHUB_ENV
          else
            SHORT_SHA=$(echo ${{ github.sha }} | cut -c1-7)
            echo "TAG=${SHORT_SHA}" >> $GITHUB_ENV
          fi

          DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
          REPO_NAME=$(echo "${{ github.repository }}" | cut -d "/" -f 2)

          echo "BACKEND_IMAGE=${DOCKER_USERNAME}/${REPO_NAME}-backend:${TAG}" >> $GITHUB_ENV
          echo "WEB_IMAGE=${DOCKER_USERNAME}/${REPO_NAME}-web:${TAG}" >> $GITHUB_ENV

      - name: Update docker-compose.yml with image tags
        run: |
          sed -i "s|build:\\s*context: ./backend|image: ${{ env.BACKEND_IMAGE }}|g" docker-compose.yml
          sed -i "s|build:\\s*context: ./web|image: ${{ env.WEB_IMAGE }}|g" docker-compose.yml
          cat docker-compose.yml

      - name: Create deploy script
        run: |
          cat > deploy.sh << 'EOL'
          #!/bin/bash

          # ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ð² Ð½ÑƒÐ¶Ð½ÑƒÑŽ Ð´Ð¸Ñ€ÐµÐºÑ‚Ð¾Ñ€Ð¸ÑŽ
          cd /var/www/finance-hub

          # Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹
          sudo docker compose pull

          # ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐµÑ€Ð²Ð¸ÑÑ‹
          sudo docker compose up -d

          # Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð½ÐµÐ¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¾Ð±Ñ€Ð°Ð·Ñ‹ Ð´Ð»Ñ ÑÐºÐ¾Ð½Ð¾Ð¼Ð¸Ð¸ Ð¼ÐµÑÑ‚Ð°
          sudo docker image prune -f

          echo "Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½!"
          EOL

          chmod +x deploy.sh

      - name: Set up SSH key
        run: |
          mkdir -p ~/.ssh
          # Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÐºÐ»ÑŽÑ‡ Ð¸ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐµÐ³Ð¾ Ð¾Ñ‚ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ñ‹Ñ… Ð¿Ñ€Ð¾Ð±Ð»ÐµÐ¼ Ñ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
          echo "${{ secrets.VPS_SSH_KEY }}" | sed 's/\\n/\n/g' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          # ÐžÑ‚Ð»Ð°Ð´ÐºÐ° - Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÐºÐ»ÑŽÑ‡Ð° (ÑÐºÑ€Ñ‹Ð²Ð°Ñ ÐµÐ³Ð¾ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ)
          echo "ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð° ÐºÐ»ÑŽÑ‡Ð°:"
          head -n 1 ~/.ssh/id_rsa
          echo "..."
          tail -n 1 ~/.ssh/id_rsa
          # ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸ ÐºÐ»ÑŽÑ‡Ð°
          ssh-keygen -l -f ~/.ssh/id_rsa || echo "ÐšÐ»ÑŽÑ‡ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð½ÐµÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ñ‹Ð¼"
          # Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ…Ð¾ÑÑ‚ Ð² known_hosts
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      - name: Deploy to VPS
        run: |
          # ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ð¾Ð³Ð¾ docker-compose.yml
          scp -P ${{ secrets.VPS_PORT || 22 }} docker-compose.yml ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/var/www/finance-hub/docker-compose.yml

          # ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´ÐµÐ¿Ð»Ð¾Ñ
          scp -P ${{ secrets.VPS_PORT || 22 }} deploy.sh ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }}:/tmp/deploy.sh

          # Ð—Ð°Ð¿ÑƒÑÐº ÑÐºÑ€Ð¸Ð¿Ñ‚Ð° Ð´ÐµÐ¿Ð»Ð¾Ñ
          ssh -p ${{ secrets.VPS_PORT || 22 }} ${{ secrets.VPS_USERNAME }}@${{ secrets.VPS_HOST }} 'bash /tmp/deploy.sh'

      - name: Cleanup SSH key
        run: rm -f ~/.ssh/id_rsa

      - name: Send notification about deploy
        if: success()
        run: |
          echo "## ðŸš€ Ð”ÐµÐ¿Ð»Ð¾Ð¹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½" > deploy-notification.md
          echo "" >> deploy-notification.md
          echo "**ÐžÐ±Ñ€Ð°Ð·Ñ‹:**" >> deploy-notification.md
          echo "- Backend: \`${{ env.BACKEND_IMAGE }}\`" >> deploy-notification.md
          echo "- Web: \`${{ env.WEB_IMAGE }}\`" >> deploy-notification.md
          echo "" >> deploy-notification.md
          echo "**Ð¥Ð¾ÑÑ‚:** \`${{ secrets.VPS_HOST }}\`" >> deploy-notification.md
          echo "**Ð”Ð°Ñ‚Ð°:** $(date)" >> deploy-notification.md

      - name: Upload deploy notification
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: deploy-notification
          path: deploy-notification.md
          retention-days: 7
